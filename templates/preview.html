<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>入力内容確認</title>
    <script>
        async function fetchPreview() {
            const urlParams = new URLSearchParams(window.location.search);
            const name = urlParams.get("name");
            const date = urlParams.get("date");

            const response = await fetch(`/preview_api?name=${name}&date=${date}`);
            if (!response.ok) {
                document.getElementById("result").innerHTML = "<p>データ取得に失敗しました。</p>";
                return;
            }

            const data = await response.json();
            const container = document.getElementById("result");
            container.innerHTML = "";

            if (data.records.length === 0) {
                container.innerHTML = "<p>該当するレコードがありません。</p>";
                return;
            }

            const table = document.createElement("table");
            table.border = 1;
            const header = table.insertRow();
            ["日付", "項目", "詳細", "時間", "コメント"].forEach(text => {
                const th = document.createElement("th");
                th.textContent = text;
                header.appendChild(th);
            });

            let total = 0;
            for (const row of data.records) {
                const tr = table.insertRow();
                tr.insertCell().textContent = row.report_date || "";
                tr.insertCell().textContent = row.category || "";
                tr.insertCell().textContent = row.detail || "";
                tr.insertCell().textContent = row.hours || "";
                tr.insertCell().textContent = row.comment || "";
                total += parseFloat(row.hours || 0);
            }

            container.appendChild(table);
            const totalP = document.createElement("p");
            totalP.textContent = `合計時間: ${total.toFixed(2)} 時間`;
            container.appendChild(totalP);
        }

        function closeWindow() {
            window.close();
        }

        window.onload = fetchPreview;
    </script>
</head>
<body>
    <h2>入力内容確認</h2>
    <div id="result"><p>読み込み中...</p></div>
    <button onclick="closeWindow()">閉じる</button>
</body>
</html>
