<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日報入力フォーム</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card { margin-top: 30px; }
    </style>
</head>
<body>
<div class="container">
    <div class="card">
        <div class="card-body">
            <h3 class="card-title mb-4">📝 日報入力フォーム</h3>
            <form id="reportForm">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="date" class="form-label">日付</label>
                        <input type="date" class="form-control" id="date" name="date" required>
                    </div>
                    <div class="col-md-6">
                        <label for="name" class="form-label">氏名</label>
                        <select class="form-select" id="name" name="name" required>
                            <option value="">選択してください</option>
                            {% for n in names %}
                                <option value="{{n}}">{{n}}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div id="task-rows">
                    <div class="row align-items-end mb-3 task-row">
                        <div class="col-md-3">
                            <select class="form-select category-select" name="category">
                                {% for c in category_map %}
                                    <option value="{{c}}">{{c}}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select detail-select" name="detail">
                                {% for d in category_map[category_map|list|first] %}
                                    <option value="{{d}}">{{d}}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" name="hours">
                                {% for i in range(1, 33) %}
                                    <option value="{{ i * 0.25 }}">{{ i * 0.25 }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control" name="comment" placeholder="コメント">
                        </div>
                        <div class="col-md-1">
                            <button type="button" class="btn btn-link text-danger remove-task">削除</button>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn btn-outline-secondary mb-3" id="addRow">＋行を追加</button>
                <p><strong>本日の合計時間:</strong> <span id="todayTotal">0</span> 時間 / <strong>今月の合計時間:</strong> <span id="monthTotal">0</span> 時間</p>

                <div class="d-flex gap-3">
                    <button type="submit" class="btn btn-success">送信</button>
                    <button type="button" class="btn btn-primary" id="previewButton">入力内容確認</button>
                    <a href="#" class="btn btn-secondary" id="masterButton">マスター一覧を見る</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    const categoryMap = {{ category_map | tojson }};

    function updateDetailOptions(row) {
        const category = row.querySelector(".category-select").value;
        const detailSelect = row.querySelector(".detail-select");
        detailSelect.innerHTML = "";
        (categoryMap[category] || []).forEach(d => {
            const opt = document.createElement("option");
            opt.value = d;
            opt.textContent = d;
            detailSelect.appendChild(opt);
        });
    }

    function updateTotalHours() {
        let today = 0.0;
        document.querySelectorAll("select[name='hours']").forEach(s => {
            today += parseFloat(s.value || 0);
        });
        document.getElementById("todayTotal").textContent = today.toFixed(2);

        const name = document.getElementById("name").value;
        const date = document.getElementById("date").value;
        if (name && date) {
            fetch(`/preview_api?date=${date}&name=${name}`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById("monthTotal").textContent = (data.monthly_hours || 0).toFixed(2);
                });
        }
    }

    document.getElementById("addRow").addEventListener("click", () => {
        const row = document.querySelector(".task-row");
        const newRow = row.cloneNode(true);
        newRow.querySelectorAll("select").forEach(s => s.selectedIndex = 0);
        newRow.querySelector("input[name='comment']").value = "";
        newRow.querySelector(".remove-task").addEventListener("click", () => {
            newRow.remove();
            updateTotalHours();
        });
        newRow.querySelector(".category-select").addEventListener("change", () => {
            updateDetailOptions(newRow);
        });
        newRow.querySelector("select[name='hours']").addEventListener("change", updateTotalHours);
        document.getElementById("task-rows").appendChild(newRow);
    });

    document.querySelectorAll(".remove-task").forEach(btn => {
        btn.addEventListener("click", () => {
            btn.closest(".task-row").remove();
            updateTotalHours();
        });
    });

    document.querySelectorAll(".category-select").forEach(sel => {
        sel.addEventListener("change", () => {
            updateDetailOptions(sel.closest(".task-row"));
        });
    });

    document.querySelectorAll("select[name='hours']").forEach(sel => {
        sel.addEventListener("change", updateTotalHours);
    });

    document.getElementById("name").addEventListener("change", updateTotalHours);
    document.getElementById("date").addEventListener("change", updateTotalHours);

    document.getElementById("reportForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const date = document.getElementById("date").value;
        const name = document.getElementById("name").value;
        const taskRows = document.querySelectorAll(".task-row");

        const tasks = Array.from(taskRows).map(row => ({
            report_date: date,
            name,
            category: row.querySelector("select[name='category']").value,
            detail: row.querySelector("select[name='detail']").value,
            hours: row.querySelector("select[name='hours']").value,
            comment: row.querySelector("input[name='comment']").value
        }));

        const res = await fetch("/submit", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ tasks })
        });

        alert(res.ok ? "送信が完了しました" : "送信に失敗しました");
    });

    document.getElementById("previewButton").addEventListener("click", () => {
        const date = document.getElementById("date").value;
        const name = document.getElementById("name").value;
        if (!date || !name) {
            alert("日付と氏名を選択してください");
            return;
        }
        const url = `/preview?date=${encodeURIComponent(date)}&name=${encodeURIComponent(name)}`;
        window.open(url, "_blank", "width=800,height=600");
    });

    document.getElementById("masterButton").addEventListener("click", () => {
        window.open("/master", "_blank", "width=800,height=600");
    });
</script>
</body>
</html>