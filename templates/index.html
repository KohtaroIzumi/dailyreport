<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>日報入力フォーム</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .task-row {
            margin-bottom: 10px;
        }
        .task-row .form-control {
            margin-bottom: 5px;
        }
        .summary {
            font-weight: bold;
            margin-top: 10px;
        }
        .btn-smaller {
            font-size: 0.9rem;
            padding: 0.4rem 0.75rem;
        }
    </style>
</head>
<body class="bg-light">
<div class="container py-4">
    <h2 class="mb-4">日報入力フォーム</h2>

    <form id="reportForm">
        <div class="row mb-3">
            <div class="col-md-6 col-12 mb-2">
                <label for="date" class="form-label">日付</label>
                <input type="date" id="date" name="date" class="form-control" required>
            </div>
            <div class="col-md-6 col-12 mb-2">
                <label for="name" class="form-label">氏名</label>
                <select id="name" name="name" class="form-select" required>
                    <option value="">選択してください</option>
                    {% for name in names %}
                        <option value="{{ name }}">{{ name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div id="tasks"></div>

        <div class="mb-3">
            <button type="button" class="btn btn-secondary btn-smaller" onclick="addTask()">＋行を追加</button>
        </div>

        <div class="summary">
            本日の合計時間: <span id="todayTotal">0</span> 時間 / 今月の合計時間: <span id="monthTotal">0</span> 時間
        </div>

        <div class="mt-3">
            <button type="submit" class="btn btn-primary">送信</button>
            <button type="button" class="btn btn-outline-secondary" onclick="confirmPreview()">入力内容確認</button>
        </div>
    </form>
</div>

<script>
    const categoryMap = {{ category_map|tojson }};
    let taskCount = 0;

    function addTask(categoryVal = "", detailVal = "", hoursVal = "", commentVal = "") {
        const container = document.getElementById("tasks");
        const div = document.createElement("div");
        div.className = "row task-row";
        div.innerHTML = `
            <div class="col-md-3 col-6">
                <select class="form-select category-select" required>
                    <option value="">項目</option>
                    {% for cat in category_map.keys() %}
                        <option value="{{ cat }}">{{ cat }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 col-6">
                <select class="form-select detail-select" required>
                    <option value="">詳細</option>
                </select>
            </div>
            <div class="col-md-2 col-4">
                <select class="form-select hours-select" required>
                    {% for i in range(0, 97) %}
                        <option value="{{ i / 4 }}">{{ i / 4 }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 col-6">
                <input type="text" class="form-control comment-input" placeholder="コメント">
            </div>
            <div class="col-md-1 col-2 d-flex align-items-center">
                <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.task-row').remove(); calculateTotal();">削除</button>
            </div>
        `;
        container.appendChild(div);

        const categorySelect = div.querySelector(".category-select");
        const detailSelect = div.querySelector(".detail-select");
        const hoursSelect = div.querySelector(".hours-select");
        const commentInput = div.querySelector(".comment-input");

        if (categoryVal) categorySelect.value = categoryVal;
        if (detailVal) {
            updateDetailOptions(categorySelect, detailSelect);
            detailSelect.value = detailVal;
        }
        if (hoursVal) hoursSelect.value = hoursVal;
        if (commentVal) commentInput.value = commentVal;

        categorySelect.addEventListener("change", () => updateDetailOptions(categorySelect, detailSelect));
        hoursSelect.addEventListener("change", calculateTotal);
    }

    function updateDetailOptions(categorySelect, detailSelect) {
        const selected = categorySelect.value;
        const details = categoryMap[selected] || [];
        detailSelect.innerHTML = '<option value="">詳細</option>';
        details.forEach(detail => {
            const opt = document.createElement("option");
            opt.value = detail;
            opt.textContent = detail;
            detailSelect.appendChild(opt);
        });
    }

    function calculateTotal() {
        let total = 0;
        document.querySelectorAll(".hours-select").forEach(sel => {
            total += parseFloat(sel.value || 0);
        });
        document.getElementById("todayTotal").textContent = total.toFixed(2);
    }

    document.getElementById("reportForm").addEventListener("submit", async function (e) {
        e.preventDefault();
        const date = document.getElementById("date").value;
        const name = document.getElementById("name").value;
        const tasks = [];

        document.querySelectorAll(".task-row").forEach(row => {
            tasks.push({
                category: row.querySelector(".category-select").value,
                detail: row.querySelector(".detail-select").value,
                hours: row.querySelector(".hours-select").value,
                comment: row.querySelector(".comment-input").value
            });
        });

        const res = await fetch("/submit", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ date, name, tasks })
        });

        const data = await res.json();
        alert(data.message);
    });

    function confirmPreview() {
        const date = document.getElementById("date").value;
        const name = document.getElementById("name").value;
        if (!date || !name) {
            alert("日付と氏名を入力してください");
            return;
        }
        window.open(`/preview?date=${date}&name=${encodeURIComponent(name)}`, "_blank");
    }

    document.getElementById("date").addEventListener("change", updateMonthlyHours);
    document.getElementById("name").addEventListener("change", updateMonthlyHours);

    async function updateMonthlyHours() {
        const date = document.getElementById("date").value;
        const name = document.getElementById("name").value;
        if (!date || !name) return;

        const res = await fetch(`/preview_api?date=${date}&name=${encodeURIComponent(name)}`);
        const data = await res.json();
        document.getElementById("monthTotal").textContent = parseFloat(data.monthly_hours || 0).toFixed(2);
    }

    // 初期表示行追加
    addTask();
</script>
</body>
</html>