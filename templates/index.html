<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Êó•Â†±ÂÖ•Âäõ„Éï„Ç©„Éº„É†</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
</head>
<body class="bg-light">
<div class="container mt-5 mb-5">
    <div class="card">
        <div class="card-body">
            <h5 class="card-title mb-4">üìù Êó•Â†±ÂÖ•Âäõ„Éï„Ç©„Éº„É†</h5>

            <form id="reportForm">
                <div class="mb-3">
                    <label for="date" class="form-label">Êó•‰ªò</label>
                    <input type="date" class="form-control" id="date" name="date" required>
                </div>

                <div class="mb-3">
                    <label for="name" class="form-label">Ê∞èÂêç</label>
                    <select class="form-select" id="name" name="name" required>
                        <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                        {% for n in names %}
                        <option value="{{n}}">{{n}}</option>
                        {% endfor %}
                    </select>
                </div>

                <div id="task-rows">
                    <div class="row align-items-end mb-3 task-row">
                        <div class="col-md-4">
                            <label class="form-label">È†ÖÁõÆ</label>
                            <select class="form-select category-select" name="category">
                                {% for c in category_map %}
                                <option value="{{c}}">{{c}}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Ë©≥Á¥∞</label>
                            <select class="form-select detail-select" name="detail">
                                {% for d in category_map[category_map|list|first] %}
                                <option value="{{d}}">{{d}}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">ÊôÇÈñì</label>
                            <select class="form-select" name="hours">
                                {% for i in range(1, 33) %}
                                <option value="{{ i * 0.25 }}">{{ i * 0.25 }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-link text-danger remove-task">ÂâäÈô§</button>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn btn-outline-primary mb-3" id="addRow">ÔºãË°å„ÇíËøΩÂä†</button>

                <div class="mb-3">
                    <label for="comment" class="form-label">„Ç≥„É°„É≥„Éà</label>
                    <textarea class="form-control" id="comment" name="comment" rows="3"></textarea>
                </div>

                <div class="d-flex justify-content-start gap-3">
                    <button type="submit" class="btn btn-primary">ÈÄÅ‰ø°</button>
                    <a href="/master" class="btn btn-link">„Éû„Çπ„Çø„Éº„ÇíÁ¢∫Ë™ç</a>
                </div>
            </form>

        </div>
    </div>
</div>

<script>
    const categoryMap = {{ category_map | tojson }};

    function updateDetailOptions(row) {
        const category = row.querySelector(".category-select").value;
        const detailSelect = row.querySelector(".detail-select");
        detailSelect.innerHTML = "";
        (categoryMap[category] || []).forEach(d => {
            const opt = document.createElement("option");
            opt.value = d;
            opt.textContent = d;
            detailSelect.appendChild(opt);
        });
    }

    document.getElementById("addRow").addEventListener("click", () => {
        const row = document.querySelector(".task-row");
        const newRow = row.cloneNode(true);
        newRow.querySelectorAll("select").forEach(s => s.selectedIndex = 0);
        newRow.querySelector(".remove-task").addEventListener("click", () => {
            newRow.remove();
        });
        document.getElementById("task-rows").appendChild(newRow);
    });

    document.querySelectorAll(".remove-task").forEach(btn => {
        btn.addEventListener("click", () => {
            btn.closest(".task-row").remove();
        });
    });

    document.querySelectorAll(".category-select").forEach(sel => {
        sel.addEventListener("change", () => {
            updateDetailOptions(sel.closest(".task-row"));
        });
    });

    document.getElementById("reportForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const date = document.getElementById("date").value;
        const name = document.getElementById("name").value;
        const comment = document.getElementById("comment").value;
        const taskRows = document.querySelectorAll(".task-row");

        const tasks = Array.from(taskRows).map(row => ({
            category: row.querySelector("select[name='category']").value,
            detail: row.querySelector("select[name='detail']").value,
            hours: row.querySelector("select[name='hours']").value
        }));

        const res = await fetch("/submit", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ date, name, comment, tasks })
        });

        const result = await res.json();
        if (res.ok) {
            alert(result.message);
        } else {
            alert("ÈÄÅ‰ø°Â§±Êïó: " + result.message);
        }
    });
</script>
</body>
</html>