<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>月次グラフ分析</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .chart-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 40px;
            margin-top: 20px;
        }
        .chart-box {
            flex: 1 1 500px;
            max-width: 600px;
            min-width: 300px;
        }
    </style>
</head>
<body class="bg-light">
<div class="container mt-4">
    <h4 class="mb-4">📊 月次グラフ分析</h4>
    <div id="graph-section"></div>
    <div class="text-center mt-4">
        <button id="addGraph" class="btn btn-outline-primary">＋ グラフ追加</button>
    </div>
</div>

<script>
    const names = [{% for n in names %}"{{n}}",{% endfor %}];

    function createGraphBlock(index) {
        const wrapper = document.createElement("div");
        wrapper.className = "mb-5 p-3 bg-white rounded shadow-sm";

        const idSuffix = `_${index}`;
        wrapper.innerHTML = `
            <div class="row mb-3">
                <div class="col-md-3">
                    <label for="month${idSuffix}" class="form-label">対象月</label>
                    <input type="month" id="month${idSuffix}" class="form-control">
                </div>
                <div class="col-md-4">
                    <label for="name${idSuffix}" class="form-label">氏名</label>
                    <select id="name${idSuffix}" class="form-select">
                        ${names.map(n => `<option value="${n}">${n}</option>`).join('')}
                    </select>
                </div>
                <div class="col-md-5 d-flex align-items-end">
                    <button class="btn btn-primary w-100" onclick="fetchGraph('${idSuffix}')">表示</button>
                </div>
            </div>
            <div id="graph-title${idSuffix}" class="fw-bold mb-2"></div>
            <div id="total-hours${idSuffix}" class="mb-2 text-muted"></div>
            <div id="no-data${idSuffix}" class="text-danger"></div>
            <div class="chart-container">
                <div id="pieChart${idSuffix}" class="chart-box"></div>
                <div id="barChart${idSuffix}" class="chart-box"></div>
            </div>
        `;
        document.getElementById("graph-section").appendChild(wrapper);
    }

    function fetchGraph(idSuffix) {
        const monthInput = document.getElementById(`month${idSuffix}`).value;
        const name = document.getElementById(`name${idSuffix}`).value;
        const titleDiv = document.getElementById(`graph-title${idSuffix}`);
        const totalDiv = document.getElementById(`total-hours${idSuffix}`);
        const noDataDiv = document.getElementById(`no-data${idSuffix}`);
        const pieDiv = document.getElementById(`pieChart${idSuffix}`);
        const barDiv = document.getElementById(`barChart${idSuffix}`);

        titleDiv.textContent = "";
        totalDiv.textContent = "";
        noDataDiv.textContent = "";
        pieDiv.innerHTML = "";
        barDiv.innerHTML = "";

        if (!monthInput) {
            noDataDiv.textContent = "📅 対象月を選択してください";
            return;
        }

        const [year, month] = monthInput.split("-");
        fetch(`/graph_data?year=${year}&month=${month}&name=${encodeURIComponent(name)}`)
            .then(res => res.json())
            .then(data => {
                if (!Array.isArray(data) || data.length === 0) {
                    noDataDiv.textContent = "該当データがありません";
                    return;
                }

                const categoryMap = {};
                let total = 0;
                data.forEach(row => {
                    const cat = row.category;
                    const hrs = parseFloat(row.hours || 0);
                    categoryMap[cat] = (categoryMap[cat] || 0) + hrs;
                    total += hrs;
                });

                const labels = Object.keys(categoryMap);
                const values = labels.map(k => categoryMap[k]);
                titleDiv.textContent = `${name} の稼働内訳`;
                totalDiv.textContent = `合計稼働時間：${total.toFixed(2)} 時間`;

                Plotly.newPlot(`pieChart${idSuffix}`, [{
                    type: "pie",
                    labels: labels,
                    values: values,
                    hole: 0.4,
                    textinfo: "percent",
                    textposition: "inside",
                    textfont: { size: 12 },
                    automargin: true
                }], {
                    title: "月次稼働時間 円グラフ",
                    height: 500,
                    width: 500,
                    margin: { t: 40, l: 20, r: 20, b: 120 },
                    showlegend: true,
                    legend: {
                        orientation: "h",
                        y: -0.3,
                        x: 0.5,
                        xanchor: "center"
                    }
                });

                Plotly.newPlot(`barChart${idSuffix}`, [{
                    type: "bar",
                    x: values,
                    y: labels,
                    orientation: "h"
                }], {
                    title: "月次稼働時間 棒グラフ",
                    margin: { t: 30, l: 120, r: 30, b: 30 },
                    height: 500
                });
            });
    }

    window.addEventListener("DOMContentLoaded", () => {
        createGraphBlock(0);
    });

    let graphIndex = 1;
    document.getElementById("addGraph").addEventListener("click", () => {
        createGraphBlock(graphIndex++);
    });
</script>
</body>
</html>